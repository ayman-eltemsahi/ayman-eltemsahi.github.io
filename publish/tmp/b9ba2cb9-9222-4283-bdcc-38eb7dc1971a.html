<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recycled Phones</title>
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
      crossorigin="anonymous"
    />
    <!-- JavaScript Bundle with Popper -->
    <!-- <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
      crossorigin="anonymous"
    ></script> -->
  </head>
  <body>
    <body>
      <div class="container">
        <h1>Title Goes Here</h1>

        <h3>Query</h3>
        <div class="input-group mb-1">
          <input
            type="text"
            class="form-control"
            placeholder="First Persona"
            aria-label="First Persona"
            aria-describedby="basic-addon2"
            id="persona-a"
          />
        </div>
        <div class="input-group mb-1">
          <input
            type="text"
            class="form-control"
            placeholder="Second Persona"
            aria-label="Second Persona"
            aria-describedby="basic-addon2"
            id="persona-b"
          />
        </div>
        <div class="input-group mb-1">
          <input
            type="text"
            class="form-control"
            placeholder="Phone Number"
            aria-label="Phone Number"
            aria-describedby="basic-addon2"
            id="phone-number"
          />
        </div>

        <div class="input-group mb-1">
          <button type="button" class="btn btn-outline-dark" onclick="get_query()">
            Get Query
          </button>
        </div>

        <br />
        <hr />
        <br />

        <div class="form-group">
          <textarea
            class="form-control"
            id="lakehouse-data"
            rows="4"
            placeholder="Paste the comma separated result from lakehouse (with header row) here..."
          ></textarea>
        </div>
        <div class="input-group mb-1">
          <button type="button" class="btn btn-outline-dark" onclick="analyze()">Analyze</button>
        </div>

        <pre style="background-color: #ccc; padding: 5px; white-space: pre-wrap" id="result"></pre>
      </div>
    </body>

    <script>
      const config = {
        minTimeWithFirstPersona: 60 * 60 * 24 * 30 * 4, // 4 months
        minTimeTillAddedToSecondPersona: 60 * 60 * 24 * 30, // 1 month
      }

      const unique = (items) => {
        const s = new Set()
        return items.filter((item) => {
          if (s.has(item)) return false
          s.add(item)
          return true
        })
      }
      const diff = (d1Str, d2Str) => (new Date(d2Str) - new Date(d1Str)) / 1000
      const maskPhone = (phone) => phone.replace(/(.{5}).*(.{2})$/, '$1*****$2')
      const fmtDate = (timestamp) => new Date(timestamp).toISOString().split('T')[0]
      const mapUser = (user) => {
        switch (user) {
          case 'verify-phone-number':
          case 'user-account-management':
            return 'The App'

          case 'sc-portal':
            return 'Customer Service'

          case 'admin':
            return 'Persona Gateway Team'

          default:
            throw new Error('unknown ' + user)
        }
      }

      const mapRawEvents = (rawEvents) => {
        const events = rawEvents.map((item) => {
          const timestamp = item.event_data_timestamp
          const type = !item.event_data_phone ? 'REMOVED' : 'ADDED' // ADDED or UPDATED
          const user = mapUser(item.event_data_user)

          return { timestamp, type, user, persona_id: item.event_data_persona_id }
        })

        const personas = [] // {persona_id, owned_from, owned_to}
        events.forEach((item) => {
          let i = personas.findIndex((p) => p.persona_id == item.persona_id)
          if (i === -1) {
            personas.push({ persona_id: item.persona_id })
            i = personas.length - 1
          }

          const personaObj = personas[i]
          // set it if the phone as been removed (we take the new addition/removal)
          // or this is the first ADDED event (if the user adds it many times, we don't override)
          if (item.type == 'ADDED' && (personaObj.owned_to || !personaObj.owned_from)) {
            personaObj.owned_from = item.timestamp
            personaObj.owned_to = undefined
            personaObj.added_by = item.user
            personaObj.added_correlation_id = item.metadata_correlation_id
          }

          if (item.type == 'REMOVED' && !personaObj.owned_to) {
            personaObj.owned_to = item.timestamp
            personaObj.removed_by = item.user
            personaObj.removed_correlation_id = item.metadata_correlation_id
          }
        })

        console.table(events)
        console.table(personas)

        return { events, personas }
      }

      const detectedRecycledPhoneOnePersona = ({ phone, ids, events: rawEvents }) => {
        const { events, personas } = mapRawEvents(rawEvents)

        if (personas.length !== 1) return
        const [persona] = personas
        if (!persona.owned_from || !persona.owned_to) return
        const duration = diff(persona.owned_from, persona.owned_to)
        if (duration < config.minTimeWithFirstPersona) return

        const summary = [
          `CX A: ${persona.persona_id}`,
          `CX B: __NOT CREATED__`,
          '',
          `Phone: ${maskPhone(phone)}`,
          '',
          '',
          `The phone was added to CX A on ${fmtDate(persona.owned_from)} and removed on ${fmtDate(
            persona.owned_to
          )} `,
          `It appears that CX B used the phone not knowing that it already belonged to an existing customer and thus, a persona B was not created.`,
          '',
          'This looks like a recycled phone.',
        ]

        return summary.join('\n')
      }

      const detectedRecycledPhoneTwoPersonas = ({ phone, ids, events: rawEvents }) => {
        const { events, personas } = mapRawEvents(rawEvents)

        const handleTwo = (personaA, personaB) => {
          if (!personaA.owned_from || !personaA.owned_to) return
          const durationPersonaA = diff(personaA.owned_from, personaA.owned_to)
          if (durationPersonaA < config.minTimeWithFirstPersona) return

          const timeBetween = diff(personaA.owned_to, personaB.owned_from)
          if (timeBetween > config.minTimeTillAddedToSecondPersona) return

          const isClaim =
            personaB.removed_correlation_id &&
            personaB.removed_correlation_id === personaA.added_correlation_id
          const removedReason = isClaim
            ? `in "${personaA.removed_by}" by being claimed by CX B`
            : `by "${personaA.removed_by}"`

          const summary = [
            `CX A: ${personaA.persona_id}`,
            `CX B: ${personaB.persona_id}`,
            '',
            `Phone: ${maskPhone(phone)}`,
            '',
            '',
            `The phone was added to CX A on ${fmtDate(
              personaA.owned_from
            )} and removed on ${fmtDate(personaA.owned_to)} ${removedReason}`,
            `The phone was added to CX B on ${fmtDate(personaB.owned_from)} through "${
              personaA.added_by
            }"`,
            '',
            'This looks like a recycled phone.',
          ]

          return summary.join('\n')
        }

        for (let i = 0; i < personas.length; ++i) {
          for (let j = i + 1; j < personas.length; ++j) {
            const res = handleTwo(personas[i], personas[j])
            if (res) return res
          }
        }
      }

      const hasHeader = (firstRow) =>
        firstRow.includes('persona_id') && firstRow.includes('timestamp')

      const findPhones = (data) => {
        const phones = unique(data.map((item) => item.event_data_phone).filter(Boolean))

        return phones.map((phone) => {
          const ids = unique(
            data
              .filter((item) => item.event_data_phone == phone)
              .map((item) => item.event_data_phone_id)
          )

          // ids.sort((a, b) => a.event_data_timestamp - b.event_data_timestamp)

          const events = data.filter((item) => ids.includes(item.event_data_phone_id))

          return { phone, ids, events }
        })
      }

      const detectedRecycledPhone = ({ phone, ids, events }) => {
        const res =
          detectedRecycledPhoneTwoPersonas({ phone, ids, events }) ||
          detectedRecycledPhoneOnePersona({ phone, ids, events })

        return res
      }

      const parse = (content) => {
        const lines = content.split('\n')
        if (!hasHeader(lines[0])) {
          throw new Error('Missing header row')
        }

        const headers = lines[0].split(',')
        lines.splice(0, 1)

        const data = lines
          .map((line) => line.trim())
          .filter(Boolean)
          .map((line) => line.split(','))
          .map((arr, index) => {
            const obj = { index }
            for (let i = 0; i < headers.length; ++i) {
              obj[headers[i]] = arr[i]
            }
            return obj
          })
          .sort((a, b) => a.event_data_timestamp.localeCompare(b.event_data_timestamp))

        const phones = findPhones(data)
        for (let phone of phones) {
          const res = detectedRecycledPhone(phone)
          if (res) return res
        }

        return "Couldn't figure this one out :("
      }
      function get_query() {
        const personaA = document.getElementById('persona-a').value
        const personaB = document.getElementById('persona-b').value
        const phone = document.getElementById('phone-number').value

        const query = [
          'SELECT * FROM bip_persona_core_eu_5y.persona_core_event',
          `where (event_data_persona_id = '${personaA}'` +
            (personaB ? ` or event_data_persona_id = '${personaB}')` : ')'),
          phone ? `or event_data_phone = '${phone}'` : '',
        ]
          .filter(Boolean)
          .join('\n')

        document.getElementById('result').innerText = query
      }

      function analyze() {
        const content = document.getElementById('lakehouse-data').value
        document.getElementById('result').innerText = parse(content)
      }
    </script>
  </body>
</html>
